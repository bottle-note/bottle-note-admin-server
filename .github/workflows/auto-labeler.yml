name: Auto Label Issues with GPT

on:
  issues:
    types: [opened]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      
    steps:
    - name: Auto Label Issue
      uses: actions/github-script@v7
      with:
        script: |
          // 1. 라벨 가져오기
          const labels = await github.rest.issues.listLabelsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo
          });
          const labelList = labels.data.map(l => l.name).join(', ');
          
          // 2. GPT API 호출 (Node.js https 모듈 사용)
          const https = require('https');
          const payload = JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [{
              role: "system",
              content: "You are a GitHub label selector. Return ONLY a JSON array of label names."
            }, {
              role: "user",
              content: `Available labels: ${labelList}\n\nIssue Title: ${context.payload.issue.title}\n\nIssue Body: ${context.payload.issue.body || ''}\n\nSelect 1-3 appropriate labels. Return JSON array only.`
            }],
            temperature: 0.3
          });
          
          const response = await new Promise((resolve, reject) => {
            const req = https.request({
              hostname: 'api.openai.com',
              path: '/v1/chat/completions',
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ${{ secrets.OPENAI_API_KEY }}'
              }
            }, (res) => {
              let data = '';
              res.on('data', chunk => data += chunk);
              res.on('end', () => resolve(JSON.parse(data)));
            });
            req.on('error', reject);
            req.write(payload);
            req.end();
          });
          
          // 3. 라벨 적용
          try {
            const selectedLabels = JSON.parse(response.choices[0].message.content);
            console.log('Selected labels:', selectedLabels);
            
            if (selectedLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,  
                issue_number: context.payload.issue.number,
                labels: selectedLabels
              });
              console.log('✅ Labels applied successfully');
            }
          } catch (e) {
            console.error('Failed to apply labels:', e);
          }
