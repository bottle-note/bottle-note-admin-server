name: Dev Deploy Workflow

# ë°°í¬ ì‘ì—… ê°œì„ ìœ¼ë¡œ ì¸í•œ ê¸°ì¡´ ì›Œí¬í”Œë¡œìš° ë¹„ í™œì„±í™”
on:
  workflow_dispatch:

# ë™ì‹œì— ì—¬ëŸ¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ì„¤ì •
concurrency:
  group: "dev-deploy"
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest  # ì›Œí¬í”Œë¡œìš°ëŠ” ìµœì‹  Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true  # ì„œë¸Œëª¨ë“ˆ ì²´í¬ì•„ì›ƒ í™œì„±í™”
          token: ${{ secrets.GIT_ACCESS_TOKEN }}  # private ì €ì¥ì†Œ ì ‘ê·¼ì„ ìœ„í•œ í† í°

      # ì„œë¸Œëª¨ë“ˆ ì—…ë°ì´íŠ¸ (ìµœì‹  ìƒíƒœë¡œ ë™ê¸°í™”)
      - name: Update submodules
        run: |
          echo "ğŸ”„ Updating git submodules..."
          git submodule update --init --recursive
          git submodule update --remote

      ## JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      ## ì›ê²© í™˜ê²½ì— ì½”ë“œ ë³µì‚¬
      - name: í”„ë¡œì íŠ¸ ë³µì‚¬
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete # rsync ëª…ë ¹ì–´ ì˜µì…˜
          remote_path: /home/bottlenote/app/bottle-note-admin-server
          remote_host: ${{ secrets.DEV_SERVER_IP }}
          remote_port: ${{ secrets.DEV_SERVER_PORT }}
          remote_user: bottlenote
          remote_key: ${{ secrets.DEV_SSH_KEY }}

      ## deploy setup ë° Gradle ë¹Œë“œ
      - name: ì„¤ì • ë°°í¬ ë° Gradle ë¹Œë“œ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_SERVER_IP }}
          port: ${{ secrets.DEV_SERVER_PORT }}
          username: ubuntu
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            echo "::group::Deploy Setup and Gradle Build"
            echo "ğŸ“ Navigating to project directory"
            cd /home/ubuntu/app/bottle-note

            echo "ğŸ“ Creating application.yml from secret"
            echo "${{ secrets.APPLICATION_DEV }}" | base64 --decode > src/main/resources/application.yml
            ls -l src/main/resources/application.yml

            echo "âš™ï¸ Starting Gradle build"
            set -x
            chmod +x gradlew
            ./gradlew clean build -x asciidoctor -x copyRestDocs
            set +x
            echo "âœ… Gradle build completed"
            echo "::endgroup::"

      ## ê°œë°œ ë„ì»¤ ì‹¤í–‰
      - name: ë„ì»¤ êµ¬ì„±
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_SERVER_IP }}
          port: ${{ secrets.DEV_SERVER_PORT }}
          username: ubuntu
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            echo "::group::Docker Compose Build and Run"
            echo "ğŸ“ Navigating to project directory"
            cd /home/ubuntu/app/bottle-note

            echo "ğŸ›‘ Stopping existing container if any"
            docker stop dev-bottle-note || echo "âš ï¸ No container to stop"
            docker rm dev-bottle-note || echo "âš ï¸ No container to remove"

            echo "ğŸš€ Building and starting container"
            docker-compose -f docker-compose-dev.yml up -d --no-deps --build dev-bottle-note

            echo "ğŸ“¦ Current running containers:"
            docker ps | grep dev-bottle-note
            echo "::endgroup::"

            echo "ğŸ§¹ Pruning unused Docker images"
            docker image prune -f